Motivation：startTransition の現実的なデモを作りたい

何をつくるか

- 編集可能な n 個の記事があり、検索画面から事前にインデックスをつけない全文検索ができるアプリ
- 記事をクリックするとエディタ画面で記事が開き、記事が編集可能になる
- レイアウトは server component demo を参考にする

覚える必要があること

- draft.js
- flexsearch
- tailwind の Headless UI
- 永続化する場合は永続化の手法も

こだわらないこと

- 新しく使うライブラリの詳細な理解
- UI

これまでの反省

- 全体像がわからないときに不安感があり、調べすぎてしまう場合がある
- 不安にかられている場合、なぞるような読み方しか出来ず、理解が進まない場合が多い（こういうときは大概 qiita とか負荷の低いものばかり読んでいた）

対策

- 不安にかられていることを自覚する。少し手を休めて不安を直視し、原因を探る。
- その上で負荷をかけて理解する
- 不安を消すには結局成功体験を積むしか無いし、いつも成功するような行為をするべき

# 2021-06-17

2021-06-17 18:23:52

ひとまず動かし方がわかったので、詳細を作り込んでいく。

createWithContent で最初から情報を入れたいが、引数のデータ型がよくわからない。string ではなく独自の型が入るが、データをどこかから取り出せるのか？

2021-06-17 20:20:43
不安は「わからない」というより「出来ない」が近いかもしれない。あまり良い抽象化と思えない非直感的な API を触ると、全体像の把握が難しくなる。どうやって動いているのかわからない巨大なコードベースを改修する際に、どこから手を付けてよいかわからなくなる感覚。エントリーポイントがどこかを認識することが重要か。（しかし大概そういうことで困るライブラリは、getting started にエントリーポイントやコアコンセプトの記載がない。）

公式ドキュメントで重要そうな箇所の「あたりをつける」訓練をしよう。30 分でこの型のデータをどう用意するかドキュメントから知る

結果：このライブラリの特徴や優位点がわかったが、withContent をどう取得すればよいかわからないまま。「わかって来たぞ」とおもって後半に細かい API 情報を眺めていたのが計画性がなく、良くなかった。「ここかここかここにあるはず」というあたりをつけることが目的なのだから、それを頭にいれて行うべきだった。

次は 10 分間ザッピングして、無理そうなら公式ドキュメント以外を見る。それでもわからなければ一度別のライブラリを使ってみる。

2021-06-17 20:56:28

コンポーネントにデータを流し込む方法について引き続き調べる。07 分までに見当がつかなければ英語圏を中心に情報を探す。

https://draftjs.org/docs/api-reference-data-conversion/

英語圏の情報を中心に探した。https://stackoverflow.com/questions/35884112/draftjs-how-to-initiate-an-editor-with-content　が探していた回答っぽい。

https://codesandbox.io/s/formik-09x-draftjs-example-forked-isvbi あたりはよく出来たアプリケーションだと思う。動くようになったら参考にして機能を作ろう

教訓：英語版 google で検索する。今回の場合日本の情報が少ないので、日本語で検索->ドキュメント → 英語版という流れより、日本語＆英語で検索 → ドキュメントがベターだった。
これまでだとドキュメントをすべて読みつくすぐらいだったので、途中で中断できたところがよかった。

（英語版と日本語版の検索結果を同時に表示する拡張とかほしい）

2021-06-17 22:09:01

データの流し込みは完成したので、複数のタブをつくり、それらからエディタコンポーネントに情報を渡す形にする。

やること

- タブの UI

- 情報の持ち方を考える

- app の構造をつくる

目標：タブコンポーネントを実装して、map で入れた情報を表示できるようにする。

結果：Radio Group を入れるまでで終わった。10 分程度で終わるかと思っていたが、インストールを含めると急いでも 20 分ぐらいはかかる

2021-06-17 22:35:08

タブコンポーネントの UI の根幹はいじらず、データの表示だけ調整する。一時間で editor までつなげる

- タイトルと本文を表示する
- データを context で管理し、dispatch で更新できるようにする。

終わらなかった。タイトルと本文を表示するまでは終わったが、context での管理までいかなかった。
色気をだして、UI を調整しようとしてしまったせい。
context 自体は 10 分で終わるだろう。次の時間でエディターへ情報を渡すまで完成させられるだろう。
TODO: 記事コンポーネント背景を白抜きにして視認性を高める　 or shadow
TODO: 現状記事コンポーネント内部の bg は select 時に背景と同じ色になってしまっている。色を変える。
TODO:　エディタ画面は白抜きにする　幅固定に

2021-06-17 23:26:49
context で記事管理、editor に選択された情報を渡し、内容を表示させる。

> なぜ Context か？あとで検索するときにデータを使いまわしたいから。

- ArticleContext コンポーネントをつくる
- editor と sidebar を子にもつコンポーネントで読み込む。

内容表示まで終わらせた。次は変更を反映させる。一つ一つ setState を渡すのも馬鹿らしいので、reducer を持つように変更しよう。

休憩

TODO: タブを overflow:hidden にして、小説本文を 3 行とかまで表示するようにする。現在の 70 文字まで表示は見た目が残念

TODO: アクティブなタブだけ本文が表示されるように。今だと 11 個が画面に入り切らない

2021-06-18 01:35:02

エディタに props を渡してもそのままではエディタが更新されないので、hooks も更新しなければならない。

- github 　レポジトリをつくる
- useEffect で更新させる
  進まず。寝る

# 2021-06-18

昨日、三時間で簡単な UI とエディタに情報を渡すことまで行った。次に、編集を記憶する必要がある。選択した記事を表示する際に、これまで表示していた記事を反映することを考えたが、useEffect で全文検索で更新を即座に検知してくれるなら逐次更新にする必要がある。（startTransition ポイント！）

データの持ち方について多少考えてみたところ、

要件

- string で持つことはできない: リッチテキストが保存されない
- 逐次更新にする必要がある：

- ひとつの巨大なオブジェクトへのマージはコストが高い印象があり、筋の悪い実装をすることになる予感がある。だが筋のいい代案がみつからず（文章の state を 11 個もつのはないし、回収コストが高い。加えて）
- 簡単な POC だから気軽にいっていいだろうか。
- 「わざと失敗してみる」と考える
- ブランチをかえることで、心理的抵抗はへるだろうか。（）

2021-06-19 23:32:54
三十分でデータの変更までやる。

わかったこと

convertToRaw 関数は js オブジェクトへの変換で、どうにも全文検索用に text へと変換するプロパティがない？`ContentState.getPlainText()か？

# 2021-07-06

React Fiber の勉強がおわった（一ヶ月ほど専念していた）ので、これを再始動する。現状エディタの編集はできるので、

- 保存
- 全文検索

この２機能を実装していく。

## 2021-07-06 11:06:11

保存機能を作る。キーバインドは後で。
保存ハンドラを作った。時間がかかりすぎ。ちょっと面倒で手がつかないっぽい。
かわりにボタンのレイアウトをいじっていた。少し代償行為チックで良くない。

## 2021-07-06 12:50:00

保存機能続き。

保存機能を作成し、保存を押したら記事を移動しても更新が保存されるようになった。

```javascript
    setArticles((prev) => {
      const newArticles = prev.map((prevArticle) => {
        if (prevArticle.title === title) return newObj;
        return prevArticle;
      });

      return newArticles;
    });
  };
```

次は目的の全文検索をやる。

2021-07-11 22:44:35
気を失っていたら 4 日間が過ぎていた。実際には、matchAll の機能を使ってコンパイラに怒られ、その原因解明に時間がかかったり、全文検索を flexsearch や luar でやるのはどうなのか、「そもそも全文検索って？」と調べていたのが中心。後半２日は UI 制作。devide を知った。振り返ってみて成長する負荷の掛け方ができていない。またポモドーロをする。

目的：検索結果のひとつをクリックすると、該当する記事が開くようにする

0.  リファクタリングする
1.  フォーカス可能にする
2.  handleChange をつける

まずリファクタリングのファイル設計方針がないので、(React Architecture: How to Structure and Organize a React Application)[https://www.taniarascia.com/react-architecture-directory-structure/]を読んで、構造の指針とその理由を言語化する。

各コンポーネントをグループに分け、フォルダを作る。form, tables, buttons,layouts といったそれぞれのフォルダ内に個々のコンポーネントのフォルダを作り、テストなどをそこに配置する。

Component.js - The actual React component
Component.styles.js - The Styled Components file for the component
Component.test.js - The tests
Component.stories.js - The Storybook file

最上層のフォルダ直下に index.js を作り、そこですべてを export する。そうすると、このような操作が簡単になる。

`import { TextField, Select, Radio } from '@components/forms'`

次のようなフォルダ構成になる。

```
└── /src
    ├── /assets
    ├── /components
    ├── /services
    ├── /store
    ├── /utils
    ├── /views
    ├── index.js
    └── App.js
```

これは多少大規模サービス向けな気がするが、試してみよう。

2021-07-11 23:43:53
コンポーネントごとにリファクタリングする

- 検索バー
- エディター
- ラジオボタン

の３つ
検索バーのリファクタリングを半分やった。次は変数名を変える。Suggestion型を自動インポートしようとしたら、testing libraryのが入ったのでそれが問題だったのだろう。

結構ゴリゴリ進めても問題なく動くことがわかったので、このように進めていく。

# 2021-07-12
昨日の続きで、リファクタリングをしないと変更しづらくなってきているので、これを変更する。

2021-07-12 14:42:03
変数名を変えていく。()でエラーが出るので、正規表現のエスケープを学ぶ。

Uncaught SyntaxError: Invalid regular expression: /(/: Unterminated group

```javascript
    const regExpEscape = (str: string) => {
      return str.replace(/[-/\\^$*+?.()|[\]{}]/g, '\\$&');
    };
```
これで解決した。ここも正規表現にすることで解決。いずれきちんと正規表現を学ぶ必要があるかもしれない。

## 2021-07-12 15:20

他のリファクタリングを終わらす。useHookにまとめる、使っていないファイルを削除する、謎変数名を変更するなどした。

## 2021-07-12 17:03:41
SearchListをクリックするとエディタに表示される記事が切り替わりたい。情報を切り替えるのは簡単だが、他にフォーカスできるように設定をしておきたい。

30分使って、Reactのアクセシビリティ設定について調べる。
TODO:React GUIのコンポーネントをみる。npmで公開されているなら入れて、exampleをいじる。
以下の三記事を中心に読んでいる。
https://www.mitsue.co.jp/knowledge/blog/a11y/201912/23_0000.html
https://zenn.dev/neet/articles/8b4d8d42fb2a5e
https://momdo.github.io/html/interaction.html#focusable
フォーカスについて、フォーカス可能・tabでフォーカス可能・クリックでフォーカス可能の三種類があることを理解した。

アクセシビリティはかなり膨大で、少し本気で取り組む必要がありそう。おそらくbuttonで簡単にできるのだが、もうすこし本腰をいれて理解したい（あとでやるのはモチベーションが大変）ので、1時間を目処に「わからないとき何を・どこで検索すればいいか」がわかるようにする。

2021-07-12 18:15:15
しばらく検索していたが、うまく集中できていなかった。

最近進みが悪いのは結局集中できていない時間でダラダラ進めていることが大きな要因なので、これを改善する。

一時的に強い負荷を掛けて、基準レベルを上げる。
https://developer.mozilla.org/ja/docs/orphaned/Web/Guide/HTML/Using_HTML_sections_and_outlines
を読んだ。これはマークアップに意味を付与するというものでアクセシビリティには関係なかった。

https://zenn.dev/neet/articles/8b4d8d42fb2a5e

これは参考になりそうなので、次はこれを継続して読む。しかし、想定以上の時間がかかっているので、まずは実装をやる。

2021-07-12 21:12:02
ul>li をul>buttonにするとフォーカスが当たらず困ったが、インスペクトするとliが挿入されていて変換されているようだったので、ul>li>buttonに変更した。するとフォーカスが当たるようになった。

次の問題はfocusをクリック操作で起こさないようにすること。

tabindexを設定する方法と、Focus-visibleで設定する方法の２つがあるはず。

うまく集中できている。

2021-07-12 22:22
focus-bisibleで設定しようとして行き詰まる。うまく以下の説明でポリフィルが必要というのでその設定をしたが、そもそもクロームらは大丈夫なので違う問題。変数をつかえるよう設定したがうまくいかず、tailwindplayで試したら思ったように行っていないので、そもそもfocus-visibleを誤解している可能性がある。

https://tailwindcss.com/docs/hover-focus-and-other-states#focus-visible

ここに時間をかけるのは本意ではないので、別の方法を探ろう。

2021-07-12 23:02:25
tabindexで問題は解決しないように思えた。

focus-visibleは設定の問題ではなく使い方が問題だと考えて、tailwindの公式例をそのまま使って成功することを確認した。

`focus:outline-none focus-visible:ring-yellow-500 focus-visible:ring-2`のように、focusの設定をfocus-visibleで上書きしなければoutline-noneのままのようだ。

反省：手を動かす時間と考える時間がうまく分けられていない。最初は書きながら考えることは難しいだろうから、考える時間をつくらないといけない。

課題：あとやるべきは選択記事の切り替えだけ。

2021-07-12 23:30
切り替えできた。特に難しいことはしていない。ただ、APPにロジックが集中してしまった。

別にこのままで良いが、誰かがこのコードを読むとしたら、メンタルモデルを作るのが難しいコードだと感じる。

特に解決策が思いつかないのでこのままにするが、可読性の低いものになっている感覚がある。「抽象化」ってここに効く？

TODO:onBlueでクエリをすべて消去して、popoverも消してしまうか検討


## 振り返り
記事の切り替えが大変なように感じていたが、かなり簡単に終わらせることができた。リファクタリングで変更の影響範囲が明確にわかるようになり、かなり機能の追加をしやすくなった。

