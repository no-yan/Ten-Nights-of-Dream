Motivation：startTransition の現実的なデモを作りたい

何をつくるか

- 編集可能な n 個の記事があり、検索画面から事前にインデックスをつけない全文検索ができるアプリ
- 記事をクリックするとエディタ画面で記事が開き、記事が編集可能になる
- レイアウトは server component demo を参考にする

覚える必要があること

- draft.js
- flexsearch
- tailwind の Headless UI
- 永続化する場合は永続化の手法も

こだわらないこと

- 新しく使うライブラリの詳細な理解
- UI

これまでの反省

- 全体像がわからないときに不安感があり、調べすぎてしまう場合がある
- 不安にかられている場合、なぞるような読み方しか出来ず、理解が進まない場合が多い（こういうときは大概 qiita とか負荷の低いものばかり読んでいた）

対策

- 不安にかられていることを自覚する。少し手を休めて不安を直視し、原因を探る。
- その上で負荷をかけて理解する
- 不安を消すには結局成功体験を積むしか無いし、いつも成功するような行為をするべき

# 2021-06-17

2021-06-17 18:23:52

ひとまず動かし方がわかったので、詳細を作り込んでいく。

createWithContent で最初から情報を入れたいが、引数のデータ型がよくわからない。string ではなく独自の型が入るが、データをどこかから取り出せるのか？

2021-06-17 20:20:43
不安は「わからない」というより「出来ない」が近いかもしれない。あまり良い抽象化と思えない非直感的な API を触ると、全体像の把握が難しくなる。どうやって動いているのかわからない巨大なコードベースを改修する際に、どこから手を付けてよいかわからなくなる感覚。エントリーポイントがどこかを認識することが重要か。（しかし大概そういうことで困るライブラリは、getting started にエントリーポイントやコアコンセプトの記載がない。）

公式ドキュメントで重要そうな箇所の「あたりをつける」訓練をしよう。30 分でこの型のデータをどう用意するかドキュメントから知る

結果：このライブラリの特徴や優位点がわかったが、withContent をどう取得すればよいかわからないまま。「わかって来たぞ」とおもって後半に細かい API 情報を眺めていたのが計画性がなく、良くなかった。「ここかここかここにあるはず」というあたりをつけることが目的なのだから、それを頭にいれて行うべきだった。

次は 10 分間ザッピングして、無理そうなら公式ドキュメント以外を見る。それでもわからなければ一度別のライブラリを使ってみる。

2021-06-17 20:56:28

コンポーネントにデータを流し込む方法について引き続き調べる。07 分までに見当がつかなければ英語圏を中心に情報を探す。

https://draftjs.org/docs/api-reference-data-conversion/

英語圏の情報を中心に探した。https://stackoverflow.com/questions/35884112/draftjs-how-to-initiate-an-editor-with-content　が探していた回答っぽい。

https://codesandbox.io/s/formik-09x-draftjs-example-forked-isvbi あたりはよく出来たアプリケーションだと思う。動くようになったら参考にして機能を作ろう

教訓：英語版 google で検索する。今回の場合日本の情報が少ないので、日本語で検索->ドキュメント → 英語版という流れより、日本語＆英語で検索 → ドキュメントがベターだった。
これまでだとドキュメントをすべて読みつくすぐらいだったので、途中で中断できたところがよかった。

（英語版と日本語版の検索結果を同時に表示する拡張とかほしい）

2021-06-17 22:09:01

データの流し込みは完成したので、複数のタブをつくり、それらからエディタコンポーネントに情報を渡す形にする。

やること

- タブの UI

- 情報の持ち方を考える

- app の構造をつくる

目標：タブコンポーネントを実装して、map で入れた情報を表示できるようにする。

結果：Radio Group を入れるまでで終わった。10 分程度で終わるかと思っていたが、インストールを含めると急いでも 20 分ぐらいはかかる

2021-06-17 22:35:08

タブコンポーネントの UI の根幹はいじらず、データの表示だけ調整する。一時間で editor までつなげる

- タイトルと本文を表示する
- データを context で管理し、dispatch で更新できるようにする。

終わらなかった。タイトルと本文を表示するまでは終わったが、context での管理までいかなかった。
色気をだして、UI を調整しようとしてしまったせい。
context 自体は 10 分で終わるだろう。次の時間でエディターへ情報を渡すまで完成させられるだろう。
TODO: 記事コンポーネント背景を白抜きにして視認性を高める　 or shadow
TODO: 現状記事コンポーネント内部の bg は select 時に背景と同じ色になってしまっている。色を変える。
TODO:　エディタ画面は白抜きにする　幅固定に

2021-06-17 23:26:49
context で記事管理、editor に選択された情報を渡し、内容を表示させる。

> なぜ Context か？あとで検索するときにデータを使いまわしたいから。

- ArticleContext コンポーネントをつくる
- editor と sidebar を子にもつコンポーネントで読み込む。

内容表示まで終わらせた。次は変更を反映させる。一つ一つ setState を渡すのも馬鹿らしいので、reducer を持つように変更しよう。

休憩

TODO: タブを overflow:hidden にして、小説本文を 3 行とかまで表示するようにする。現在の 70 文字まで表示は見た目が残念

TODO: アクティブなタブだけ本文が表示されるように。今だと 11 個が画面に入り切らない

2021-06-18 01:35:02

エディタに props を渡してもそのままではエディタが更新されないので、hooks も更新しなければならない。

- github 　レポジトリをつくる
- useEffect で更新させる
  進まず。寝る

# 2021-06-18

昨日、三時間で簡単な UI とエディタに情報を渡すことまで行った。次に、編集を記憶する必要がある。選択した記事を表示する際に、これまで表示していた記事を反映することを考えたが、useEffect で全文検索で更新を即座に検知してくれるなら逐次更新にする必要がある。（startTransition ポイント！）

データの持ち方について多少考えてみたところ、

要件

- string で持つことはできない: リッチテキストが保存されない
- 逐次更新にする必要がある：

- ひとつの巨大なオブジェクトへのマージはコストが高い印象があり、筋の悪い実装をすることになる予感がある。だが筋のいい代案がみつからず（文章の state を 11 個もつのはないし、回収コストが高い。加えて）
- 簡単な POC だから気軽にいっていいだろうか。
- 「わざと失敗してみる」と考える
- ブランチをかえることで、心理的抵抗はへるだろうか。（）

2021-06-19 23:32:54
三十分でデータの変更までやる。

わかったこと

convertToRaw 関数は js オブジェクトへの変換で、どうにも全文検索用に text へと変換するプロパティがない？`ContentState.getPlainText()か？

# 2021-07-06

React Fiber の勉強がおわった（一ヶ月ほど専念していた）ので、これを再始動する。現状エディタの編集はできるので、

- 保存
- 全文検索

この２機能を実装していく。

## 2021-07-06 11:06:11

保存機能を作る。キーバインドは後で。
保存ハンドラを作った。時間がかかりすぎ。ちょっと面倒で手がつかないっぽい。
かわりにボタンのレイアウトをいじっていた。少し代償行為チックで良くない。

## 2021-07-06 12:50:00

保存機能続き。

保存機能を作成し、保存を押したら記事を移動しても更新が保存されるようになった。

```javascript
    setArticles((prev) => {
      const newArticles = prev.map((prevArticle) => {
        if (prevArticle.title === title) return newObj;
        return prevArticle;
      });

      return newArticles;
    });
  };
```

次は目的の全文検索をやる。
